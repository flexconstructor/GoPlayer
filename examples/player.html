<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Go Player</title>
    <style>
        .wrapper {
            position:absolute;
            top: 220px;
            left: 200px;

        }

    </style>
    <script src="../js/megapix-image.js"></script>
    <script src="../js/heartcode-canvasloader-min.js"></script>
    <script>

        var image_arr=[];
        var buffer=0;
        var preloader;



        function init() {
            createWebSocket();
            canvas=this.document.getElementById("canvas");
            context=canvas.getContext("2d");
            preloader = new CanvasLoader('canvasloader-container');
            preloader.setDiameter(26); // default is 40
            preloader.setDensity(41); // default is 40
            preloader.setRange(1); // default is 1.3
            preloader.setFPS(28); // default is 24
            preloader.show(); // Hidden by default

            // This bit is only for positioning - not necessary
            var loaderObj = document.getElementById("canvasLoader");
            loaderObj.style.position = "absolute";
            loaderObj.style["top"] = preloader.getDiameter() * -0.5 + "px";
            loaderObj.style["left"] = preloader.getDiameter() * -0.5 + "px";


        }

        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function createWebSocket(){

        var stream_name=getParameterByName("streamname");
        var serversocket = new WebSocket("ws://localhost:9095/tv/"+stream_name);


        serversocket.onopen=function(evt){
           // writeToScreen("connected to "+stream_name);
        }

        serversocket.onerror=function(evt){
            writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
            preloader.kill()
        }
        serversocket.onclose=function(evt){
            writeToScreen("disconnected from "+stream_name);
            preloader.kill();
        }
        serversocket.onmessage=function(evt){

                //renderImage(evt.data)
            if(evt.data instanceof Blob) {
                var mpImg = new MegaPixImage(evt.data);
                image_arr.push(mpImg);
                mpImg.imageLoadListeners.push(renderImage)
            }else{
                var data=JSON.parse(evt.data);
                if(data.Message=="metadata") {
                    onMetadata(data)
                }else if(data.Message=="error"){
                    onError(data)
                }
              var output=document.getElementById("output")
                var pre = document.createElement("p");
                pre.style.wordWrap = "break-word";
                pre.innerHTML = evt.data;
                output.appendChild(pre);
            }

        }

        }

        function renderImage(target,options){

            if(image_arr.length>buffer){
                var mpImg=image_arr.pop();
                mpImg.render(canvas,{width: canvas.width});
                mpImg.imageLoadListeners=null;
                mpImg.srcImage=null;
                mpImg=null;
                if(preloader)preloader.hide();

            }

        }

        function writeToScreen(message) {
            console.log("message: "+message)
            var context=canvas.getContext("2d");
            context.font="14pt Calibri";
            context.fillStyle = 'red';
            context.clearRect(0,0,canvas.width,canvas.height);
            context.fillText(message,20,200 *0.5)

        }


        function onMetadata(value){
            canvas.width=value.Width;
            canvas.height=value.Height;

        }

        function onError(value){

        }




        window.addEventListener("load", init, false);
    </script>
</head>
<body>
<h1>Hello, GoPlayer!</h1>
<canvas id="canvas" width="550" height="400"><</canvas>
<div id="canvasloader-container" class="wrapper"></div>
<div id="output"/>

</body>
</html>